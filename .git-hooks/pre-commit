#!/bin/bash
# ============================================================
# ZMART v0.69 - Pre-Commit Hook (File & Code Validation)
# ============================================================
# Purpose: Validate code quality and run spec compliance checks
# Runs: BEFORE commit is created
#
# Pattern Prevention: #2 (Spec Drift), #4 (Schema Drift)
#
# Note: Story validation moved to commit-msg hook
#
# Installation:
#   cp .git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
# ============================================================

# Get staged files
STAGED_FILES=$(git diff --cached --name-status)

# ============================================================
# SPEC COMPLIANCE VALIDATION (Rust code only)
# ============================================================

if echo "$STAGED_FILES" | grep -qE '\.rs$'; then
    if [ -f "scripts/validate-spec-compliance.sh" ]; then
        echo ""
        echo "ðŸ” Running specification compliance validation..."
        if ! ./scripts/validate-spec-compliance.sh; then
            echo ""
            echo "âŒ FAIL: Specification compliance check failed"
            echo "   Fix API signature mismatches before committing"
            echo ""
            echo "ðŸ’¡ Bypass (NOT RECOMMENDED): git commit --no-verify"
            echo ""
            exit 1
        else
            echo "âœ… Spec compliance: PASSED"
        fi
    else
        echo "âš ï¸  WARNING: Spec validation script not found (skipping)"
    fi
fi

# ============================================================
# SCHEMA DRIFT PREVENTION (Supabase migrations)
# ============================================================

# Auto-regenerate Supabase types if migrations changed
if echo "$STAGED_FILES" | grep -q "supabase/migrations/"; then
    echo "ðŸ“Š Database migration detected - regenerating types..."
    if command -v supabase &> /dev/null; then
        supabase gen types typescript --local > types/database.ts 2>/dev/null && \
        git add types/database.ts && \
        echo "âœ… Supabase types updated automatically"
    else
        echo "âš ï¸  Warning: supabase CLI not found - types not regenerated"
        echo "   Run manually: supabase gen types typescript --local > types/database.ts"
    fi
fi

echo ""
echo "âœ… Pre-commit validation passed"
exit 0
