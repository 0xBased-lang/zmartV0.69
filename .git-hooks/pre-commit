#!/bin/bash
# ============================================================
# ZMART v0.69 - Pre-Commit Hook (File & Code Validation)
# ============================================================
# Purpose: Validate code quality and run spec compliance checks
# Runs: BEFORE commit is created
#
# Pattern Prevention: #2 (Spec Drift), #4 (Schema Drift)
#
# Note: Story validation moved to commit-msg hook
#
# Installation:
#   cp .git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
# ============================================================

# Get staged files
STAGED_FILES=$(git diff --cached --name-status)

# ============================================================
# SPEC COMPLIANCE VALIDATION (Rust code only)
# ============================================================

if echo "$STAGED_FILES" | grep -qE '\.rs$'; then
    if [ -f "scripts/validate-spec-compliance.sh" ]; then
        echo ""
        echo "üîç Running specification compliance validation..."
        if ! ./scripts/validate-spec-compliance.sh; then
            echo ""
            echo "‚ùå FAIL: Specification compliance check failed"
            echo "   Fix API signature mismatches before committing"
            echo ""
            echo "üí° Bypass (NOT RECOMMENDED): git commit --no-verify"
            echo ""
            exit 1
        else
            echo "‚úÖ Spec compliance: PASSED"
        fi
    else
        echo "‚ö†Ô∏è  WARNING: Spec validation script not found (skipping)"
    fi
fi

# ============================================================
# SCHEMA DRIFT PREVENTION (Supabase migrations)
# ============================================================

# Auto-regenerate Supabase types if migrations changed
if echo "$STAGED_FILES" | grep -q "supabase/migrations/"; then
    echo "üìä Database migration detected - regenerating types..."
    if command -v supabase &> /dev/null; then
        supabase gen types typescript --local > types/database.ts 2>/dev/null && \
        git add types/database.ts && \
        echo "‚úÖ Supabase types updated automatically"
    else
        echo "‚ö†Ô∏è  Warning: supabase CLI not found - types not regenerated"
        echo "   Run manually: supabase gen types typescript --local > types/database.ts"
    fi
fi

# ============================================================
# PROGRESS TRACKER PROTECTION (Fix 7/8)
# ============================================================

PROGRESS_FILE="docs/25_DAY_PROGRESS_TRACKER.md"

# Check if progress tracker is staged
if echo "$STAGED_FILES" | grep -q "^M.*$PROGRESS_FILE$"; then
    # Check if CURRENT_DAY line was modified
    CURRENT_DAY_CHANGED=$(git diff --cached "$PROGRESS_FILE" | grep -E '^\+\*\*Current Day\*\*:' || echo "")

    if [ ! -z "$CURRENT_DAY_CHANGED" ]; then
        echo ""
        echo "‚ùå ERROR: Manual edit to CURRENT_DAY detected"
        echo ""
        echo "   File: $PROGRESS_FILE"
        echo "   Changed line: $(echo $CURRENT_DAY_CHANGED | tr -d '+')"
        echo ""
        echo "   üîí CURRENT_DAY must be updated via scripts only:"
        echo ""
        echo "      1. Complete current day's work"
        echo "      2. Run: npm run validate-day-complete"
        echo "      3. Script will auto-advance to next day (future fix)"
        echo ""
        echo "   This ensures proper validation and tracking."
        echo ""
        echo "   üí° Bypass (NOT RECOMMENDED): git commit --no-verify"
        echo ""
        exit 1
    fi
fi

echo ""
echo "‚úÖ Pre-commit validation passed"
exit 0
