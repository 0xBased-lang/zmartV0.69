#!/bin/bash
# ============================================================
# ZMART v0.69 - Smart Pre-Commit Hook
# ============================================================
# Purpose: Enforce story-first development for features
# Pattern Prevention: #1 (Methodology Abandonment Cascade)
#
# Installation:
#   cp .git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
# ============================================================

# Get staged files
STAGED_FILES=$(git diff --cached --name-status)

# Get commit message (from git commit -m or editor)
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
else
    COMMIT_MSG=""
fi

# Extract commit type (feat, fix, docs, chore, etc.)
# Note: Using BSD grep compatible syntax (macOS)
COMMIT_TYPE=$(echo "$COMMIT_MSG" | grep -Eo '^(feat|fix|refactor):' || echo "")

# Check if this is a feature/fix/refactor commit with code changes
HAS_CODE_CHANGES=$(echo "$STAGED_FILES" | grep -qE '\.(ts|tsx|rs|sql)$' && echo "yes" || echo "no")

# Enforce story reference ONLY for feat/fix/refactor with code changes
if [[ $COMMIT_TYPE =~ ^(feat|fix|refactor): ]] && [[ $HAS_CODE_CHANGES == "yes" ]]; then
    if [[ ! $COMMIT_MSG =~ Story\ [0-9]+\.[0-9]+ ]]; then
        echo ""
        echo "âŒ ERROR: $COMMIT_TYPE commits with code changes MUST reference a story"
        echo ""
        echo "   âœ… Correct format:"
        echo "      feat: Story 3.5 - Add betting interface"
        echo "      fix: Story 3.5 - Resolve TypeScript error"
        echo "      refactor: Story 3.5 - Extract utility function"
        echo ""
        echo "   â„¹ï¸  Story file location: docs/stories/STORY-X.Y.md"
        echo "   â„¹ï¸  Use template: docs/stories/STORY-TEMPLATE.md"
        echo ""
        echo "   ðŸ’¡ Bypass (NOT RECOMMENDED): git commit --no-verify"
        echo ""
        exit 1
    fi
fi

# Allow these commit types WITHOUT story reference:
# - docs: (documentation changes)
# - chore: (dependency updates, config)
# - ci: (CI/CD pipeline changes)
# - test: (test-only changes)
# - style: (formatting, no code change)

# Auto-regenerate Supabase types if migrations changed
if echo "$STAGED_FILES" | grep -q "supabase/migrations/"; then
    echo "ðŸ“Š Database migration detected - regenerating types..."
    if command -v supabase &> /dev/null; then
        supabase gen types typescript --local > types/database.ts 2>/dev/null && \
        git add types/database.ts && \
        echo "âœ… Supabase types updated automatically"
    else
        echo "âš ï¸  Warning: supabase CLI not found - types not regenerated"
        echo "   Run manually: supabase gen types typescript --local > types/database.ts"
    fi
fi

echo "âœ… Pre-commit validation passed"
exit 0
