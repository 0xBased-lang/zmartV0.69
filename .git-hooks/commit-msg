#!/bin/bash
# ============================================================
# ZMART v0.69 - Commit Message Hook (Story Validation)
# ============================================================
# Purpose: Validate commit messages reference stories and enforce DoD
# Runs: AFTER commit message written, BEFORE commit finalized
# Receives: Commit message file path as $1
#
# Pattern Prevention: #1 (Methodology Abandonment), #2 (Spec Drift)
#
# Installation:
#   cp .git-hooks/commit-msg .git/hooks/commit-msg
#   chmod +x .git/hooks/commit-msg
# ============================================================

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Get staged files to check for code changes
STAGED_FILES=$(git diff --cached --name-status)

# Extract commit type (feat, fix, docs, chore, etc.)
COMMIT_TYPE=$(echo "$COMMIT_MSG" | grep -Eo '^(feat|fix|refactor):' || echo "")

# Check if this commit has code changes
HAS_CODE_CHANGES=$(echo "$STAGED_FILES" | grep -qE '\.(ts|tsx|rs|sql)$' && echo "yes" || echo "no")

# ============================================================
# STORY VALIDATION (feat/fix/refactor with code changes)
# ============================================================

# Enforce story reference ONLY for feat/fix/refactor with code changes
if [[ $COMMIT_TYPE =~ ^(feat|fix|refactor): ]] && [[ $HAS_CODE_CHANGES == "yes" ]]; then
    if [[ ! $COMMIT_MSG =~ Story\ ([0-9]+\.[0-9]+) ]]; then
        echo ""
        echo "‚ùå ERROR: $COMMIT_TYPE commits with code changes MUST reference a story"
        echo ""
        echo "   ‚úÖ Correct format:"
        echo "      feat: Story 3.5 - Add betting interface"
        echo "      fix: Story 3.5 - Resolve TypeScript error"
        echo "      refactor: Story 3.5 - Extract utility function"
        echo ""
        echo "   ‚ÑπÔ∏è  Story file location: docs/stories/STORY-X.Y.md"
        echo "   ‚ÑπÔ∏è  Use template: docs/stories/STORY-TEMPLATE.md"
        echo ""
        echo "   üí° Bypass (NOT RECOMMENDED): git commit --no-verify"
        echo ""
        exit 1
    fi

    # Extract story number
    STORY_NUM=$(echo "$COMMIT_MSG" | grep -Eo 'Story [0-9]+\.[0-9]+' | grep -Eo '[0-9]+\.[0-9]+')
    STORY_FILE="docs/stories/STORY-$STORY_NUM.md"

    # Check if story file exists
    if [ ! -f "$STORY_FILE" ]; then
        echo ""
        echo "‚ö†Ô∏è  WARNING: Story file not found: $STORY_FILE"
        echo "   Create story file before committing code"
        echo ""
        # Not blocking - file might be in different location
    else
        echo "üìã Story file found: $STORY_FILE"

        # Extract tier from story file
        TIER=$(grep -E '^\*\*Tier:\*\*.*Tier [0-9]' "$STORY_FILE" | grep -Eo 'Tier [0-9]' | grep -Eo '[0-9]' | head -1)

        if [ -z "$TIER" ]; then
            echo "‚ö†Ô∏è  WARNING: Could not detect story tier - skipping tier validation"
        else
            echo "üéØ Detected Tier: $TIER"

            # ============================================================
            # TIER 1/2: STRICT BLOCKING
            # ============================================================
            if [[ "$TIER" =~ ^[12]$ ]]; then
                echo ""
                echo "üîí TIER $TIER (Foundation/Core) - STRICT VALIDATION MODE"
                echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

                TIER_ERRORS=0

                # Check 1: Story status must be COMPLETE
                if ! grep -qE 'Status:.*‚úÖ.*COMPLETE' "$STORY_FILE"; then
                    echo "‚ùå FAIL: Story status must be '‚úÖ COMPLETE'"
                    echo "   Current status: $(grep 'Status:' "$STORY_FILE" | head -1)"
                    echo "   Update $STORY_FILE before committing"
                    TIER_ERRORS=$((TIER_ERRORS + 1))
                else
                    echo "‚úÖ Story status: COMPLETE"
                fi

                # Check 2: DoD checklist must be complete (no unchecked boxes)
                if grep -qE '^- \[ \]' "$STORY_FILE"; then
                    echo "‚ùå FAIL: Definition of Done checklist incomplete"
                    UNCHECKED=$(grep -cE '^- \[ \]' "$STORY_FILE")
                    echo "   Found $UNCHECKED unchecked items"
                    echo "   Complete all DoD checklist items in $STORY_FILE"
                    TIER_ERRORS=$((TIER_ERRORS + 1))
                else
                    echo "‚úÖ DoD checklist: Complete"
                fi

                # Summary
                echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                if [ $TIER_ERRORS -gt 0 ]; then
                    echo ""
                    echo "‚ùå TIER $TIER VALIDATION FAILED ($TIER_ERRORS errors)"
                    echo ""
                    echo "Fix these issues before committing foundation/core code."
                    echo "üí° Bypass (NOT RECOMMENDED): git commit --no-verify"
                    echo ""
                    exit 1
                else
                    echo "‚úÖ TIER $TIER VALIDATION PASSED"
                fi

            # ============================================================
            # TIER 3: WARNING MODE
            # ============================================================
            elif [[ "$TIER" == "3" ]]; then
                echo ""
                echo "‚ö†Ô∏è  TIER 3 (Standard) - WARNING MODE"
                echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

                # Check story status (warn only)
                if ! grep -qE 'Status:.*COMPLETE' "$STORY_FILE"; then
                    echo "‚ö†Ô∏è  WARNING: Story not marked COMPLETE (allowed for Tier 3)"
                fi

                # Check DoD checklist (warn only)
                if grep -qE '^- \[ \]' "$STORY_FILE"; then
                    UNCHECKED=$(grep -cE '^- \[ \]' "$STORY_FILE")
                    echo "‚ö†Ô∏è  WARNING: $UNCHECKED DoD items unchecked (allowed for Tier 3)"
                fi

                echo "‚úÖ TIER 3 allows flexible completion - proceeding"

            # ============================================================
            # TIER 4: PERMISSIVE MODE
            # ============================================================
            elif [[ "$TIER" == "4" ]]; then
                echo ""
                echo "üöÄ TIER 4 (Quick Wins) - PERMISSIVE MODE (no validation)"
            fi
        fi
    fi
fi

# ============================================================
# 25-DAY ROADMAP VALIDATION (Anchor Program Work)
# ============================================================

# Check if commit affects Anchor programs
AFFECTS_PROGRAMS=$(echo "$STAGED_FILES" | grep -qE 'programs/.*\.(rs|toml)$' && echo "yes" || echo "no")

if [[ $AFFECTS_PROGRAMS == "yes" ]]; then
    # Get current day from progress tracker
    if [ -f "docs/25_DAY_PROGRESS_TRACKER.md" ]; then
        CURRENT_DAY=$(grep "^\*\*Current Day\*\*:" "docs/25_DAY_PROGRESS_TRACKER.md" | sed 's/.*: \([0-9]*\).*/\1/')

        if [ ! -z "$CURRENT_DAY" ] && [ "$CURRENT_DAY" -gt 0 ]; then
            # ============================================================
            # VALIDATION MARKER CHECK (Fix 3/8)
            # ============================================================
            MARKER_FILE=".validation/day-${CURRENT_DAY}-validated"

            if [ ! -f "$MARKER_FILE" ]; then
                echo ""
                echo "‚ùå ERROR: No validation marker found for Day $CURRENT_DAY"
                echo ""
                echo "   Run validation before committing:"
                echo "   $ npm run validate-day"
                echo ""
                echo "   This ensures build/tests are passing before you commit."
                echo ""
                exit 1
            fi

            # Check if marker is stale (older than today)
            MARKER_DATE=$(cat "$MARKER_FILE")
            TODAY=$(date "+%Y-%m-%d")

            if [ "$MARKER_DATE" != "$TODAY" ]; then
                echo ""
                echo "‚ùå ERROR: Validation marker is stale (from $MARKER_DATE)"
                echo ""
                echo "   Re-run validation:"
                echo "   $ npm run validate-day"
                echo ""
                exit 1
            fi

            echo "‚úÖ Validation marker valid (today: $TODAY)"
        fi
    fi

    # Extract day number from commit message
    if [[ $COMMIT_MSG =~ Day\ ([0-9]+) ]]; then
        DAY_NUM=$(echo "$COMMIT_MSG" | grep -Eo 'Day [0-9]+' | grep -Eo '[0-9]+')

        # Get current day from progress tracker
        if [ -f "docs/25_DAY_PROGRESS_TRACKER.md" ]; then
            CURRENT_DAY=$(grep "^\*\*Current Day\*\*:" "docs/25_DAY_PROGRESS_TRACKER.md" | sed 's/.*: \([0-9]*\).*/\1/')

            if [ ! -z "$CURRENT_DAY" ] && [ "$CURRENT_DAY" -gt 0 ]; then
                if [ "$DAY_NUM" != "$CURRENT_DAY" ]; then
                    # ============================================================
                    # DAY MISMATCH BLOCKING (Fix 1/8)
                    # ============================================================
                    echo ""
                    echo "‚ùå ERROR: Day mismatch detected!"
                    echo ""
                    echo "   Commit references: Day $DAY_NUM"
                    echo "   Current day is:    Day $CURRENT_DAY"
                    echo ""
                    echo "   üîß Fix options:"
                    echo "      1. Update commit message to 'Day $CURRENT_DAY'"
                    echo "      2. If Day $CURRENT_DAY is truly complete, run:"
                    echo "         npm run validate-day-complete"
                    echo "         (Day will auto-advance in future fix)"
                    echo ""
                    echo "   üí° Bypass (NOT RECOMMENDED): git commit --no-verify"
                    echo ""
                    exit 1
                else
                    echo "‚úÖ Day reference matches current day: Day $CURRENT_DAY"
                fi
            fi
        fi
    else
        # Missing day reference for program work (Fix 1/8)
        echo ""
        echo "‚ùå ERROR: Anchor program changes MUST reference day number"
        echo ""
        echo "   Format: feat: Story X.Y - Day Z - [description]"
        echo "   Example: feat: Story 2.1 - Day 3 - Implement LMSR math"
        echo ""
        echo "   See: docs/25_DAY_ANCHOR_ROADMAP.md for day numbers"
        echo ""
        echo "   üí° Bypass (NOT RECOMMENDED): git commit --no-verify"
        echo ""
        exit 1
    fi
fi

echo ""
echo "‚úÖ Commit message validation passed"
exit 0
