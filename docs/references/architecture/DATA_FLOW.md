# DATA_FLOW.md - Complete Data Flow Reference

**Category:** Architecture Reference
**Tags:** [data-flow, transactions, events, state, lifecycle]
**Last Updated:** 2025-11-09 00:45 PST

---

## Quick Links

- â¬†ï¸ [Back to CLAUDE.md](../../../CLAUDE.md)
- ğŸ”— [Integration Map](./INTEGRATION_MAP.md)
- ğŸ“¦ [Programs Reference](../components/PROGRAMS_REFERENCE.md)
- ğŸ”§ [Backend Reference](../components/BACKEND_REFERENCE.md)
- ğŸ“š [API Reference](../api/API_REFERENCE.md) â³

---

## ğŸ¯ Purpose

**Complete catalog of all data flows in ZMART V0.69**, from user actions to blockchain state changes to database updates to real-time UI updates.

This document answers:
- "Where does this data come from?"
- "Where does this data go?"
- "How long does each step take?"
- "What happens if a step fails?"

---

## ğŸ“Š Data Flow Overview

### Three Primary Flow Types

```
1. User Actions â†’ Blockchain (Write Path)
   User input â†’ Transaction â†’ On-chain execution â†’ Event emission
   Time: 2-5 seconds
   Examples: Create market, buy shares, resolve market

2. Blockchain â†’ Database (Index Path)
   Event emission â†’ Webhook â†’ Event Indexer â†’ Database write â†’ WebSocket broadcast
   Time: 1-5 seconds
   Examples: All on-chain events indexed for querying

3. Database â†’ Frontend (Read Path)
   API request â†’ Database query â†’ Response formatting â†’ Frontend render
   Time: 50-500ms
   Examples: Load markets, view positions, read discussions
```

---

## ğŸ”„ Complete Lifecycle Flows

### 1. Market Creation Flow

**End-to-End: User creates prediction market**

```
Step 1: User Input (Frontend - Phase 4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User fills form:                                             â”‚
â”‚ - Question: "Will Bitcoin reach $100k by end of 2025?"      â”‚
â”‚ - End date: 2025-12-31 23:59:59                             â”‚
â”‚ - Liquidity parameter: 100 SOL                               â”‚
â”‚ - Initial YES probability: 50%                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 0ms - instant
                      â–¼
Step 2: Transaction Building
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend calculates:                                         â”‚
â”‚ - Initial shares: q_yes = q_no = b * ln(2) â‰ˆ 0.693 * 100   â”‚
â”‚ - Market PDA: derive(program_id, [market], creator, nonce) â”‚
â”‚ - Rent: ~0.01 SOL for MarketAccount                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 10-50ms - calculation
                      â–¼
Step 3: Wallet Signing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Wallet popup:                                                â”‚
â”‚ - Shows transaction details                                  â”‚
â”‚ - User clicks "Approve"                                      â”‚
â”‚ - Wallet signs transaction                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 2-10 seconds - user action
                      â–¼
Step 4: RPC Submission
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Helius RPC receives transaction:                            â”‚
â”‚ - Validates signature                                        â”‚
â”‚ - Forwards to Solana leader                                  â”‚
â”‚ - Returns transaction signature                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 100-500ms - network
                      â–¼
Step 5: Blockchain Execution
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ zmart-core::create_market()                                 â”‚
â”‚ 1. Validate parameters                                       â”‚
â”‚    - Check end_time > now()                                  â”‚
â”‚    - Check liquidity_parameter > 0                           â”‚
â”‚    - Check question not empty                                â”‚
â”‚ 2. Calculate initial state                                   â”‚
â”‚    - shares_yes = shares_no = b * ln(2)                     â”‚
â”‚    - liquidity = creator_deposit (100 SOL)                   â”‚
â”‚    - state = PROPOSED                                         â”‚
â”‚ 3. Create MarketAccount PDA                                  â”‚
â”‚    - Allocate space (~500 bytes)                            â”‚
â”‚    - Deduct rent (~0.01 SOL)                                â”‚
â”‚    - Write market data                                       â”‚
â”‚ 4. Emit log:                                                 â”‚
â”‚    Program log: MarketCreated { market_id, question, ... }  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 400ms - slot confirmation
                      â–¼
Step 6: Transaction Confirmation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Solana network:                                              â”‚
â”‚ - Transaction included in block                              â”‚
â”‚ - Validators confirm                                         â”‚
â”‚ - Status: finalized                                          â”‚
â”‚ - Slot: 123456789                                            â”‚
â”‚ - Signature: 5j7s8k9l...                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 400-800ms - network propagation
                      â–¼
Step 7: Helius Webhook Trigger
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Helius monitors transaction logs:                           â”‚
â”‚ - Detects MarketCreated event                               â”‚
â”‚ - Parses program logs                                        â”‚
â”‚ - Constructs webhook payload                                 â”‚
â”‚ - POST to Event Indexer                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 200-1000ms - webhook delivery
                      â–¼
Step 8: Event Indexer Processing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Indexer receives webhook:                             â”‚
â”‚ POST /api/webhooks/solana                                    â”‚
â”‚ {                                                            â”‚
â”‚   "type": "TRANSACTION",                                     â”‚
â”‚   "signature": "5j7s8k9l...",                                â”‚
â”‚   "events": [{                                               â”‚
â”‚     "type": "MarketCreated",                                 â”‚
â”‚     "data": {                                                â”‚
â”‚       "marketId": "7h3g...",                                 â”‚
â”‚       "creator": "5KQw...",                                  â”‚
â”‚       "question": "Will Bitcoin reach $100k by 2025?",       â”‚
â”‚       "endTime": 1735689600,                                 â”‚
â”‚       "liquidityParameter": 100000000                        â”‚
â”‚     }                                                        â”‚
â”‚   }]                                                         â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ Validates HMAC signature                                     â”‚
â”‚ Parses event data                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 50-200ms - parsing
                      â–¼
Step 9: Database Write
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase INSERT:                                             â”‚
â”‚ INSERT INTO markets (                                        â”‚
â”‚   market_id,                                                 â”‚
â”‚   creator,                                                   â”‚
â”‚   question,                                                  â”‚
â”‚   end_time,                                                  â”‚
â”‚   liquidity_parameter,                                       â”‚
â”‚   shares_yes,                                                â”‚
â”‚   shares_no,                                                 â”‚
â”‚   liquidity,                                                 â”‚
â”‚   state,                                                     â”‚
â”‚   created_at,                                                â”‚
â”‚   transaction_signature                                      â”‚
â”‚ ) VALUES (                                                   â”‚
â”‚   '7h3g...',                                                 â”‚
â”‚   '5KQw...',                                                 â”‚
â”‚   'Will Bitcoin reach $100k by 2025?',                       â”‚
â”‚   '2025-12-31 23:59:59',                                     â”‚
â”‚   100000000,                                                 â”‚
â”‚   69300000,                                                  â”‚
â”‚   69300000,                                                  â”‚
â”‚   100000000,                                                 â”‚
â”‚   'PROPOSED',                                                â”‚
â”‚   NOW(),                                                     â”‚
â”‚   '5j7s8k9l...'                                              â”‚
â”‚ );                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 50-200ms - database write
                      â–¼
Step 10: Supabase Realtime Trigger
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase broadcasts change:                                  â”‚
â”‚ - Detects new row in markets table                          â”‚
â”‚ - Triggers realtime subscription                             â”‚
â”‚ - Emits to WebSocket Server                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 50-100ms - internal event
                      â–¼
Step 11: WebSocket Broadcast
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocket Server:                                            â”‚
â”‚ - Receives Supabase realtime event                          â”‚
â”‚ - Formats for frontend:                                      â”‚
â”‚   {                                                          â”‚
â”‚     "type": "market:created",                                â”‚
â”‚     "data": {                                                â”‚
â”‚       "marketId": "7h3g...",                                 â”‚
â”‚       "question": "Will Bitcoin reach $100k by 2025?",       â”‚
â”‚       "creator": "5KQw...",                                  â”‚
â”‚       "endTime": "2025-12-31T23:59:59Z",                     â”‚
â”‚       "state": "PROPOSED"                                     â”‚
â”‚     }                                                        â”‚
â”‚   }                                                          â”‚
â”‚ - Broadcasts to all subscribed clients                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 50-200ms - broadcast
                      â–¼
Step 12: Frontend Update (Phase 4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend receives WebSocket event:                          â”‚
â”‚ - Updates React Query cache                                  â”‚
â”‚ - Triggers re-render                                         â”‚
â”‚ - Shows success notification                                 â”‚
â”‚ - Market appears in list                                     â”‚
â”‚ - Creator redirected to market page                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL TIME: 2-5 seconds end-to-end
```

---

### 2. Buy Shares Flow

**End-to-End: User buys YES shares**

```
Step 1: User Input
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Market page (Frontend):                                      â”‚
â”‚ - User enters: 10 shares                                     â”‚
â”‚ - Selects: YES outcome                                       â”‚
â”‚ - Clicks: "Buy YES"                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 0ms - instant
                      â–¼
Step 2: Cost Calculation (Client-Side Preview)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend LMSR calculation:                                   â”‚
â”‚ Current state:                                               â”‚
â”‚   shares_yes = 69.3 SOL (69,300,000 lamports)               â”‚
â”‚   shares_no  = 69.3 SOL                                      â”‚
â”‚   b          = 100 SOL                                       â”‚
â”‚                                                              â”‚
â”‚ Calculate cost:                                              â”‚
â”‚   C(q) = b * ln(e^(q_yes/b) + e^(q_no/b))                  â”‚
â”‚   C_before = 100 * ln(e^0.693 + e^0.693) â‰ˆ 100.693         â”‚
â”‚                                                              â”‚
â”‚   q_yes_after = 69.3 + 10 = 79.3                           â”‚
â”‚   C_after = 100 * ln(e^0.793 + e^0.693) â‰ˆ 101.234          â”‚
â”‚                                                              â”‚
â”‚   cost = C_after - C_before = 0.541 SOL                    â”‚
â”‚                                                              â”‚
â”‚ Add 10% fee: 0.541 * 1.1 = 0.595 SOL total                 â”‚
â”‚                                                              â”‚
â”‚ Display: "Cost: 0.595 SOL" (live updates as user types)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 5-20ms - calculation
                      â–¼
Step 3: Slippage Protection
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User sets slippage tolerance: 2% (default)                  â”‚
â”‚ max_cost = 0.595 * 1.02 = 0.607 SOL                        â”‚
â”‚                                                              â”‚
â”‚ If actual cost > max_cost, transaction reverts             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 0ms - included in tx
                      â–¼
Step 4: Transaction Building
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Instruction: buy_shares                                      â”‚
â”‚ Accounts:                                                    â”‚
â”‚   - market (mut)                                             â”‚
â”‚   - position (mut, init if first trade)                     â”‚
â”‚   - trader (signer)                                          â”‚
â”‚   - system_program                                           â”‚
â”‚ Parameters:                                                  â”‚
â”‚   - outcome: 0 (YES)                                         â”‚
â”‚   - amount: 10,000,000,000 (10 SOL worth)                   â”‚
â”‚   - max_cost: 607,000,000 (0.607 SOL)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 10-50ms - build tx
                      â–¼
Step 5: Wallet Signing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Wallet shows:                                                â”‚
â”‚ - Instruction: buy_shares                                    â”‚
â”‚ - Estimated cost: 0.595 SOL + 0.000005 SOL (tx fee)        â”‚
â”‚ - Total: ~0.595 SOL                                          â”‚
â”‚ User approves                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 2-10 seconds - user action
                      â–¼
Step 6: RPC Submission â†’ Blockchain Execution
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ zmart-core::buy_shares()                                    â”‚
â”‚                                                              â”‚
â”‚ 1. Load accounts                                             â”‚
â”‚    market_account = load(market_pda)                        â”‚
â”‚    user_position = load_or_init(position_pda)              â”‚
â”‚                                                              â”‚
â”‚ 2. Validate state                                            â”‚
â”‚    assert!(market.state == ACTIVE)                          â”‚
â”‚    assert!(now() < market.end_time)                         â”‚
â”‚                                                              â”‚
â”‚ 3. Calculate exact cost (LMSR)                              â”‚
â”‚    C_before = b * ln(e^(q_yes/b) + e^(q_no/b))             â”‚
â”‚    C_after  = b * ln(e^((q_yes+amount)/b) + e^(q_no/b))    â”‚
â”‚    base_cost = C_after - C_before                           â”‚
â”‚                                                              â”‚
â”‚    Using binary search for precision:                       â”‚
â”‚    actual_cost = 541,234,567 lamports (0.541234567 SOL)    â”‚
â”‚                                                              â”‚
â”‚ 4. Add fees                                                  â”‚
â”‚    protocol_fee = actual_cost * 0.03 = 16,237,037          â”‚
â”‚    creator_fee  = actual_cost * 0.02 = 10,824,691          â”‚
â”‚    staker_fee   = actual_cost * 0.05 = 27,061,728          â”‚
â”‚    total_fees = 54,123,456                                  â”‚
â”‚    total_cost = 541,234,567 + 54,123,456 = 595,358,023    â”‚
â”‚                                                              â”‚
â”‚ 5. Check slippage                                            â”‚
â”‚    assert!(total_cost <= max_cost)  // 595,358,023 <= 607M â”‚
â”‚    âœ… Pass                                                   â”‚
â”‚                                                              â”‚
â”‚ 6. Transfer SOL                                              â”‚
â”‚    transfer(trader â†’ market.liquidity, total_cost)          â”‚
â”‚                                                              â”‚
â”‚ 7. Update market state                                       â”‚
â”‚    market.shares_yes += 10,000,000,000                      â”‚
â”‚    market.liquidity += 595,358,023                           â”‚
â”‚    market.total_fees_collected += 54,123,456                â”‚
â”‚                                                              â”‚
â”‚ 8. Update user position                                      â”‚
â”‚    position.shares_yes += 10,000,000,000                    â”‚
â”‚    position.total_invested += 595,358,023                   â”‚
â”‚    position.trade_count += 1                                â”‚
â”‚                                                              â”‚
â”‚ 9. Emit log                                                  â”‚
â”‚    Program log: SharesPurchased {                           â”‚
â”‚      market_id: "7h3g...",                                   â”‚
â”‚      trader: "5KQw...",                                      â”‚
â”‚      outcome: YES,                                           â”‚
â”‚      shares: 10000000000,                                    â”‚
â”‚      cost: 595358023,                                        â”‚
â”‚      fees: 54123456                                          â”‚
â”‚    }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 400-800ms - confirmation
                      â–¼
Step 7: Webhook â†’ Event Indexer
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Helius webhook payload:                                      â”‚
â”‚ {                                                            â”‚
â”‚   "type": "TRANSACTION",                                     â”‚
â”‚   "signature": "3a5b...",                                    â”‚
â”‚   "events": [{                                               â”‚
â”‚     "type": "SharesPurchased",                               â”‚
â”‚     "data": {                                                â”‚
â”‚       "marketId": "7h3g...",                                 â”‚
â”‚       "trader": "5KQw...",                                   â”‚
â”‚       "outcome": "YES",                                      â”‚
â”‚       "shares": 10000000000,                                 â”‚
â”‚       "cost": 595358023,                                     â”‚
â”‚       "fees": 54123456                                       â”‚
â”‚     }                                                        â”‚
â”‚   }]                                                         â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 200-1000ms - webhook
                      â–¼
Step 8: Database Writes (3 tables)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Indexer writes:                                        â”‚
â”‚                                                              â”‚
â”‚ 1. INSERT INTO trades                                        â”‚
â”‚    - market_id, trader, outcome, shares, cost, fees, tx_sig â”‚
â”‚                                                              â”‚
â”‚ 2. UPDATE markets                                            â”‚
â”‚    - shares_yes += 10000000000                              â”‚
â”‚    - liquidity += 595358023                                  â”‚
â”‚    - total_fees_collected += 54123456                       â”‚
â”‚    - price_yes = recalculate()                              â”‚
â”‚                                                              â”‚
â”‚ 3. UPSERT positions                                          â”‚
â”‚    - shares_yes += 10000000000                              â”‚
â”‚    - total_invested += 595358023                            â”‚
â”‚    - trade_count += 1                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 100-300ms - 3 writes
                      â–¼
Step 9: WebSocket Broadcasts (3 events)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocket Server emits:                                      â”‚
â”‚                                                              â”‚
â”‚ Event 1: trade:executed                                      â”‚
â”‚ {                                                            â”‚
â”‚   "type": "trade:executed",                                  â”‚
â”‚   "marketId": "7h3g...",                                     â”‚
â”‚   "trader": "5KQw...",                                       â”‚
â”‚   "outcome": "YES",                                          â”‚
â”‚   "shares": 10,                                              â”‚
â”‚   "cost": 0.595                                              â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ Event 2: market:updated                                      â”‚
â”‚ {                                                            â”‚
â”‚   "type": "market:updated",                                  â”‚
â”‚   "marketId": "7h3g...",                                     â”‚
â”‚   "priceYes": 0.53, // Updated from 0.50                    â”‚
â”‚   "liquidity": 100.595                                       â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ Event 3: position:updated                                    â”‚
â”‚ {                                                            â”‚
â”‚   "type": "position:updated",                                â”‚
â”‚   "userId": "5KQw...",                                       â”‚
â”‚   "marketId": "7h3g...",                                     â”‚
â”‚   "sharesYes": 10,                                           â”‚
â”‚   "totalInvested": 0.595                                     â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 50-200ms - broadcast
                      â–¼
Step 10: Frontend Updates
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ React Query cache invalidation:                             â”‚
â”‚ - Market price chart updates (YES: 50% â†’ 53%)              â”‚
â”‚ - Liquidity display updates (100 â†’ 100.595 SOL)            â”‚
â”‚ - User portfolio updates (+10 YES shares)                   â”‚
â”‚ - Trade history shows new trade                              â”‚
â”‚ - Activity feed shows "User bought 10 YES shares"          â”‚
â”‚ - Success toast: "Purchase successful!"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL TIME: 3-7 seconds end-to-end
```

---

### 3. Vote Aggregation Flow

**End-to-End: Off-chain vote â†’ On-chain aggregation**

```
Step 1: User Votes (Frontend - Phase 4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks "Like" on proposal                              â”‚
â”‚ - Market is in PROPOSED state                               â”‚
â”‚ - Voting period active (72 hours)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 0ms - instant
                      â–¼
Step 2: API Request
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/votes/proposal                                     â”‚
â”‚ Headers:                                                     â”‚
â”‚   Authorization: Bearer {jwt_token}                         â”‚
â”‚ Body:                                                        â”‚
â”‚ {                                                            â”‚
â”‚   "market_id": "7h3g...",                                    â”‚
â”‚   "vote_type": "like"                                        â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 50-200ms - HTTP
                      â–¼
Step 3: Authentication & Validation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Gateway:                                                 â”‚
â”‚ 1. Verify JWT signature                                     â”‚
â”‚ 2. Extract wallet address from token                        â”‚
â”‚ 3. Validate market exists and is in PROPOSED state          â”‚
â”‚ 4. Check user hasn't voted yet (1 vote per user)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 20-100ms - validation
                      â–¼
Step 4: Database Write
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase INSERT:                                             â”‚
â”‚ INSERT INTO votes (                                          â”‚
â”‚   market_id,                                                 â”‚
â”‚   voter,                                                     â”‚
â”‚   vote_type,                                                 â”‚
â”‚   vote_context,                                              â”‚
â”‚   aggregated,                                                â”‚
â”‚   created_at                                                 â”‚
â”‚ ) VALUES (                                                   â”‚
â”‚   '7h3g...',                                                 â”‚
â”‚   '5KQw...',                                                 â”‚
â”‚   'like',                                                    â”‚
â”‚   'proposal',                                                â”‚
â”‚   false,                                                     â”‚
â”‚   NOW()                                                      â”‚
â”‚ )                                                            â”‚
â”‚ ON CONFLICT (market_id, voter, vote_context) DO NOTHING;   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 50-150ms - write
                      â–¼
Step 5: API Response
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response:                                                    â”‚
â”‚ {                                                            â”‚
â”‚   "success": true,                                           â”‚
â”‚   "vote_id": "abc123...",                                    â”‚
â”‚   "aggregated": false,                                       â”‚
â”‚   "next_aggregation": "2025-11-09T01:00:00Z"                â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ Frontend shows: "Vote recorded. Will be submitted on-chain  â”‚
â”‚ within 5-10 minutes."                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VOTE STORED OFF-CHAIN (fast, cheap, no gas fees)

   ... Time passes (up to 5 minutes) ...

Step 6: Vote Aggregator Cron Trigger
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PM2 cron: */5 * * * * (every 5 minutes)                     â”‚
â”‚ Vote Aggregator Service starts                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 0ms - cron trigger
                      â–¼
Step 7: Fetch Pending Votes
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query Supabase:                                              â”‚
â”‚ SELECT market_id, vote_type, COUNT(*)                       â”‚
â”‚ FROM votes                                                   â”‚
â”‚ WHERE aggregated = false                                     â”‚
â”‚   AND vote_context = 'proposal'                              â”‚
â”‚ GROUP BY market_id, vote_type;                              â”‚
â”‚                                                              â”‚
â”‚ Result:                                                      â”‚
â”‚ market_id  | vote_type | count                              â”‚
â”‚ -----------+-----------+------                              â”‚
â”‚ 7h3g...    | like      | 73                                 â”‚
â”‚ 7h3g...    | dislike   | 27                                 â”‚
â”‚ 9k2f...    | like      | 45                                 â”‚
â”‚ 9k2f...    | dislike   | 55                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 100-300ms - query
                      â–¼
Step 8: Calculate Aggregated Results
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ For each market:                                             â”‚
â”‚                                                              â”‚
â”‚ Market 7h3g:                                                 â”‚
â”‚   total_votes = 73 + 27 = 100                               â”‚
â”‚   approval_rate = 73 / 100 = 0.73 (73%)                     â”‚
â”‚   threshold = 0.70 (70%)                                     â”‚
â”‚   result: APPROVED âœ…                                        â”‚
â”‚                                                              â”‚
â”‚ Market 9k2f:                                                 â”‚
â”‚   total_votes = 45 + 55 = 100                               â”‚
â”‚   approval_rate = 45 / 100 = 0.45 (45%)                     â”‚
â”‚   threshold = 0.70 (70%)                                     â”‚
â”‚   result: REJECTED âŒ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 5-20ms - calculation
                      â–¼
Step 9: Submit On-Chain Transactions
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ For Market 7h3g (APPROVED):                                 â”‚
â”‚                                                              â”‚
â”‚ Instruction: aggregate_proposal_votes                       â”‚
â”‚ Accounts:                                                    â”‚
â”‚   - market (mut)                                             â”‚
â”‚   - proposal_vote (mut, init if first)                      â”‚
â”‚   - authority (signer)                                       â”‚
â”‚   - system_program                                           â”‚
â”‚ Parameters:                                                  â”‚
â”‚   - total_votes: 100                                         â”‚
â”‚   - approval_rate: 7300 (73% as basis points)               â”‚
â”‚                                                              â”‚
â”‚ zmart-core::aggregate_proposal_votes()                      â”‚
â”‚ 1. Create/update ProposalVote account                       â”‚
â”‚ 2. Check threshold: 73% >= 70% âœ…                           â”‚
â”‚ 3. Update market state: PROPOSED â†’ APPROVED                 â”‚
â”‚ 4. Set approval_timestamp                                   â”‚
â”‚ 5. Emit log: ProposalApproved                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 400-800ms per market
                      â–¼
Step 10: Mark Votes as Aggregated
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase UPDATE:                                             â”‚
â”‚ UPDATE votes                                                 â”‚
â”‚ SET aggregated = true,                                       â”‚
â”‚     aggregated_at = NOW(),                                   â”‚
â”‚     transaction_signature = '3a5b...'                        â”‚
â”‚ WHERE market_id = '7h3g...'                                  â”‚
â”‚   AND vote_context = 'proposal'                              â”‚
â”‚   AND aggregated = false;                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 50-200ms - update
                      â–¼
Step 11: Event Indexing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Helius webhook â†’ Event Indexer                              â”‚
â”‚ Update markets table:                                        â”‚
â”‚   state = 'APPROVED'                                         â”‚
â”‚   approval_timestamp = NOW()                                 â”‚
â”‚   total_proposal_votes = 100                                 â”‚
â”‚   approval_rate = 0.73                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 200-1000ms - webhook
                      â–¼
Step 12: WebSocket Notification
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Broadcast:                                                   â”‚
â”‚ {                                                            â”‚
â”‚   "type": "proposal:approved",                               â”‚
â”‚   "marketId": "7h3g...",                                     â”‚
â”‚   "totalVotes": 100,                                         â”‚
â”‚   "approvalRate": 0.73,                                      â”‚
â”‚   "state": "APPROVED",                                       â”‚
â”‚   "canActivate": true                                        â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 50-200ms - broadcast
                      â–¼
Step 13: Frontend Update
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Market page shows:                                           â”‚
â”‚ - "âœ… Proposal Approved (73% approval)"                     â”‚
â”‚ - State badge: PROPOSED â†’ APPROVED                          â”‚
â”‚ - Show "Activate Market" button for creator                 â”‚
â”‚ - Voting UI disappears                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL TIME: 5-10 minutes (cron interval)
COST: 1 on-chain transaction (â‰ˆ$0.0001 on devnet)
BENEFIT: Cheap off-chain voting, batched on-chain submission
```

---

### 4. Market Resolution Flow

**End-to-End: Market expires â†’ Resolving â†’ Finalized**

```
Step 1: Market Expiration
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Market state:                                                â”‚
â”‚ - end_time: 2025-12-31 23:59:59                             â”‚
â”‚ - Current time: 2026-01-01 00:00:00                         â”‚
â”‚ - State: ACTIVE                                              â”‚
â”‚ - Trading stopped (end_time passed)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   ... Time passes ...

Step 2: Market Monitor Cron Check
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PM2 cron: */5 * * * * (every 5 minutes)                     â”‚
â”‚ Market Monitor Service runs                                 â”‚
â”‚                                                              â”‚
â”‚ Query Supabase:                                              â”‚
â”‚ SELECT * FROM markets                                        â”‚
â”‚ WHERE state = 'ACTIVE'                                       â”‚
â”‚   AND end_time < NOW();                                      â”‚
â”‚                                                              â”‚
â”‚ Found: Market 7h3g (Bitcoin $100k prediction)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 100-300ms - query
                      â–¼
Step 3: Transition to RESOLVING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Market Monitor submits transaction:                         â”‚
â”‚                                                              â”‚
â”‚ Instruction: transition_to_resolving                        â”‚
â”‚ Accounts:                                                    â”‚
â”‚   - market (mut)                                             â”‚
â”‚   - authority (signer)                                       â”‚
â”‚ Parameters: none                                             â”‚
â”‚                                                              â”‚
â”‚ zmart-core::transition_to_resolving()                       â”‚
â”‚ 1. Validate: state == ACTIVE                                â”‚
â”‚ 2. Validate: now() >= end_time                              â”‚
â”‚ 3. Update: state = RESOLVING                                â”‚
â”‚ 4. Set: resolution_start = now()                            â”‚
â”‚ 5. Emit log: MarketResolving                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 400-800ms - confirmation
                      â–¼
Step 4: Event Indexing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Helius webhook â†’ Event Indexer                              â”‚
â”‚ UPDATE markets SET                                           â”‚
â”‚   state = 'RESOLVING',                                       â”‚
â”‚   resolution_start = '2026-01-01 00:05:00'                   â”‚
â”‚ WHERE market_id = '7h3g...';                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 200-1000ms - webhook
                      â–¼
Step 5: Frontend Shows Resolution UI
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Market page updates:                                         â”‚
â”‚ - State badge: ACTIVE â†’ RESOLVING                           â”‚
â”‚ - Show resolution interface                                  â”‚
â”‚ - Trading disabled (greyed out)                              â”‚
â”‚ - Show timer: "48 hours remaining to submit result"         â”‚
â”‚ - Show "Submit Result" form for creator/admin               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 6: Creator Submits Result
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Creator determines outcome:                                  â”‚
â”‚ - Bitcoin reached $105k on 2025-12-20                       â”‚
â”‚ - Result: YES                                                â”‚
â”‚ - Clicks "Submit YES as final result"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ user action
                      â–¼
Step 7: Submit Result On-Chain
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Instruction: submit_result                                   â”‚
â”‚ Accounts:                                                    â”‚
â”‚   - market (mut)                                             â”‚
â”‚   - authority (signer, must be creator)                     â”‚
â”‚ Parameters:                                                  â”‚
â”‚   - result: YES (0)                                          â”‚
â”‚                                                              â”‚
â”‚ zmart-core::submit_result()                                 â”‚
â”‚ 1. Validate: state == RESOLVING                             â”‚
â”‚ 2. Validate: signer == market.creator                       â”‚
â”‚ 3. Set: market.final_result = YES                           â”‚
â”‚ 4. Set: market.result_submitted_at = now()                  â”‚
â”‚ 5. Emit log: ResultSubmitted                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 400-800ms - confirmation
                      â–¼
Step 8: Dispute Window Starts
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 48-hour dispute window:                                      â”‚
â”‚ - Users can raise disputes if they disagree                 â”‚
â”‚ - Requires dispute voting (70% threshold)                   â”‚
â”‚ - Timer counts down on frontend                              â”‚
â”‚ - If no disputes: auto-finalize after 48h                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   ... 48 hours pass with no disputes ...

Step 9: Market Monitor Auto-Finalize Check
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Market Monitor cron (every 5 min):                          â”‚
â”‚ Query:                                                       â”‚
â”‚ SELECT * FROM markets                                        â”‚
â”‚ WHERE state = 'RESOLVING'                                    â”‚
â”‚   AND final_result IS NOT NULL                              â”‚
â”‚   AND result_submitted_at < NOW() - INTERVAL '48 hours';    â”‚
â”‚                                                              â”‚
â”‚ Found: Market 7h3g (dispute window passed)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 100-300ms - query
                      â–¼
Step 10: Finalize Market
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Instruction: finalize_market                                 â”‚
â”‚ Accounts:                                                    â”‚
â”‚   - market (mut)                                             â”‚
â”‚   - authority (signer)                                       â”‚
â”‚ Parameters: none                                             â”‚
â”‚                                                              â”‚
â”‚ zmart-core::finalize_market()                               â”‚
â”‚ 1. Validate: state == RESOLVING                             â”‚
â”‚ 2. Validate: now() >= result_submitted_at + 48h             â”‚
â”‚ 3. Validate: final_result is set                            â”‚
â”‚ 4. Update: state = FINALIZED                                â”‚
â”‚ 5. Set: finalized_at = now()                                â”‚
â”‚ 6. Enable: claims_enabled = true                            â”‚
â”‚ 7. Calculate total winnings pool                            â”‚
â”‚ 8. Emit log: MarketFinalized                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 400-800ms - confirmation
                      â–¼
Step 11: Event Indexing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPDATE markets SET                                           â”‚
â”‚   state = 'FINALIZED',                                       â”‚
â”‚   finalized_at = NOW(),                                      â”‚
â”‚   claims_enabled = true                                      â”‚
â”‚ WHERE market_id = '7h3g...';                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 200-1000ms - webhook
                      â–¼
Step 12: Frontend Shows Claim UI
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Market page updates:                                         â”‚
â”‚ - State badge: RESOLVING â†’ FINALIZED                        â”‚
â”‚ - Result badge: "âœ… YES Won"                                â”‚
â”‚ - For YES holders: "Claim Winnings" button                  â”‚
â”‚ - For NO holders: "You lost 0.595 SOL" (can't claim)       â”‚
â”‚ - Show final statistics                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL TIME: 48+ hours (dispute window)
```

---

### 5. Claim Winnings Flow

**End-to-End: User claims winnings after market finalized**

```
Step 1: User Initiates Claim
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User's position:                                             â”‚
â”‚ - Holds: 10 YES shares                                       â”‚
â”‚ - Market result: YES won                                     â”‚
â”‚ - Total invested: 0.595 SOL                                  â”‚
â”‚ - Potential winnings: calculated on-chain                    â”‚
â”‚                                                              â”‚
â”‚ User clicks "Claim Winnings" button                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 0ms - instant
                      â–¼
Step 2: Calculate Winnings (Preview)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend calculates preview:                                 â”‚
â”‚                                                              â”‚
â”‚ Market state:                                                â”‚
â”‚   liquidity = 150 SOL                                        â”‚
â”‚   shares_yes = 100                                           â”‚
â”‚   shares_no = 50                                             â”‚
â”‚   result = YES                                               â”‚
â”‚                                                              â”‚
â”‚ User's share of winnings:                                    â”‚
â”‚   user_shares = 10 YES                                       â”‚
â”‚   total_winning_shares = 100 YES                             â”‚
â”‚   user_percentage = 10 / 100 = 10%                           â”‚
â”‚   total_pool = 150 SOL (liquidity)                           â”‚
â”‚   user_winnings = 150 * 0.10 = 15 SOL                       â”‚
â”‚                                                              â”‚
â”‚ Display: "You will receive â‰ˆ15 SOL"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 5-20ms - calculation
                      â–¼
Step 3: Transaction Building
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Instruction: claim_winnings                                  â”‚
â”‚ Accounts:                                                    â”‚
â”‚   - market (mut)                                             â”‚
â”‚   - position (mut)                                           â”‚
â”‚   - winner (signer)                                          â”‚
â”‚   - system_program                                           â”‚
â”‚ Parameters: none                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 10-50ms - build tx
                      â–¼
Step 4: Wallet Signing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Wallet shows:                                                â”‚
â”‚ - Instruction: claim_winnings                                â”‚
â”‚ - No cost (receiving SOL, not sending)                      â”‚
â”‚ - Transaction fee: ~0.000005 SOL                            â”‚
â”‚ User approves                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 2-10 seconds - user action
                      â–¼
Step 5: Blockchain Execution
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ zmart-core::claim_winnings()                                â”‚
â”‚                                                              â”‚
â”‚ 1. Load accounts                                             â”‚
â”‚    market = load(market_pda)                                â”‚
â”‚    position = load(position_pda)                            â”‚
â”‚                                                              â”‚
â”‚ 2. Validate state                                            â”‚
â”‚    assert!(market.state == FINALIZED)                       â”‚
â”‚    assert!(market.claims_enabled)                           â”‚
â”‚    assert!(!position.claimed)                               â”‚
â”‚                                                              â”‚
â”‚ 3. Check winning outcome                                     â”‚
â”‚    if market.final_result == YES {                          â”‚
â”‚      winning_shares = position.shares_yes                   â”‚
â”‚      total_winning_shares = market.shares_yes               â”‚
â”‚    } else {                                                  â”‚
â”‚      winning_shares = position.shares_no                    â”‚
â”‚      total_winning_shares = market.shares_no                â”‚
â”‚    }                                                         â”‚
â”‚                                                              â”‚
â”‚    User case: market.final_result = YES                     â”‚
â”‚    winning_shares = 10,000,000,000                          â”‚
â”‚    total_winning_shares = 100,000,000,000                   â”‚
â”‚                                                              â”‚
â”‚ 4. Calculate exact payout                                    â”‚
â”‚    user_percentage = winning_shares / total_winning_shares  â”‚
â”‚    user_percentage = 10B / 100B = 0.10 (10%)                â”‚
â”‚                                                              â”‚
â”‚    total_pool = market.liquidity = 150,000,000,000 lamports â”‚
â”‚    payout = total_pool * user_percentage                    â”‚
â”‚    payout = 150B * 0.10 = 15,000,000,000 lamports (15 SOL) â”‚
â”‚                                                              â”‚
â”‚ 5. Transfer SOL                                              â”‚
â”‚    transfer(market.liquidity â†’ winner, 15,000,000,000)      â”‚
â”‚                                                              â”‚
â”‚ 6. Update state                                              â”‚
â”‚    position.claimed = true                                  â”‚
â”‚    position.payout_amount = 15,000,000,000                  â”‚
â”‚    position.claimed_at = now()                              â”‚
â”‚    market.total_claimed += 15,000,000,000                   â”‚
â”‚    market.claims_processed += 1                             â”‚
â”‚                                                              â”‚
â”‚ 7. Emit log                                                  â”‚
â”‚    Program log: WinningsClaimed {                           â”‚
â”‚      market_id: "7h3g...",                                   â”‚
â”‚      winner: "5KQw...",                                      â”‚
â”‚      payout: 15000000000                                     â”‚
â”‚    }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 400-800ms - confirmation
                      â–¼
Step 6: Event Indexing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Helius webhook â†’ Event Indexer                              â”‚
â”‚                                                              â”‚
â”‚ UPDATE positions SET                                         â”‚
â”‚   claimed = true,                                            â”‚
â”‚   payout_amount = 15000000000,                               â”‚
â”‚   claimed_at = NOW()                                         â”‚
â”‚ WHERE market_id = '7h3g...'                                  â”‚
â”‚   AND user_id = '5KQw...';                                   â”‚
â”‚                                                              â”‚
â”‚ UPDATE markets SET                                           â”‚
â”‚   total_claimed = total_claimed + 15000000000,               â”‚
â”‚   claims_processed = claims_processed + 1                    â”‚
â”‚ WHERE market_id = '7h3g...';                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 200-1000ms - webhook
                      â–¼
Step 7: WebSocket Notification
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Broadcast:                                                   â”‚
â”‚ {                                                            â”‚
â”‚   "type": "winnings:claimed",                                â”‚
â”‚   "marketId": "7h3g...",                                     â”‚
â”‚   "winner": "5KQw...",                                       â”‚
â”‚   "payout": 15.0                                             â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 50-200ms - broadcast
                      â–¼
Step 8: Frontend Update
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User's wallet balance increases:                            â”‚
â”‚ - Before: 50 SOL                                             â”‚
â”‚ - After: 65 SOL (+15 SOL)                                    â”‚
â”‚                                                              â”‚
â”‚ Portfolio updates:                                           â”‚
â”‚ - Show "âœ… Claimed 15 SOL"                                  â”‚
â”‚ - Net profit: 15 - 0.595 = 14.405 SOL profit               â”‚
â”‚ - ROI: (14.405 / 0.595) * 100 = 2,420% ROI                 â”‚
â”‚                                                              â”‚
â”‚ Success notification:                                        â”‚
â”‚ "ğŸ‰ Claimed 15 SOL! Net profit: +14.405 SOL"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL TIME: 3-7 seconds
NET RESULT: User profits 14.405 SOL from 0.595 SOL investment
```

---

## ğŸ“ Data Sources & Destinations

### Data Origin Map

```
User Input (Frontend)
â”œâ”€ Market creation parameters
â”œâ”€ Trade inputs (amount, outcome, slippage)
â”œâ”€ Vote selections (like/dislike)
â”œâ”€ Discussion posts
â””â”€ Resolution results

Blockchain (On-Chain State)
â”œâ”€ MarketAccount (source of truth)
â”œâ”€ UserPosition (user holdings)
â”œâ”€ GlobalConfig (system parameters)
â””â”€ VoteRecord (aggregated votes)

Helius RPC
â”œâ”€ Transaction confirmations
â”œâ”€ Account state queries
â””â”€ Event logs

Helius Webhooks
â”œâ”€ Real-time transaction events
â”œâ”€ Program logs
â””â”€ Account change notifications

Supabase (Off-Chain Database)
â”œâ”€ Market list (indexed from blockchain)
â”œâ”€ Trade history (indexed from blockchain)
â”œâ”€ User votes (off-chain, aggregated periodically)
â””â”€ Discussions (off-chain only)

External APIs
â”œâ”€ Pinata (IPFS uploads) [planned]
â””â”€ Redis (caching) [planned]
```

### Data Destination Map

```
Blockchain Storage
â”œâ”€ MarketAccount (250+ bytes per market)
â”œâ”€ UserPosition (150+ bytes per user per market)
â”œâ”€ GlobalConfig (200+ bytes, singleton)
â””â”€ VoteRecord (100+ bytes per vote context)

Supabase Tables
â”œâ”€ markets (10-20 columns)
â”œâ”€ trades (8-12 columns)
â”œâ”€ positions (8-12 columns)
â”œâ”€ votes (6-10 columns)
â”œâ”€ discussions (6-10 columns)
â””â”€ users (5-8 columns)

Frontend State
â”œâ”€ React Query cache (in-memory)
â”œâ”€ Wallet state (connected account)
â””â”€ WebSocket subscriptions (active)

Logs & Monitoring
â”œâ”€ PM2 logs (file system)
â”œâ”€ Supabase logs (cloud)
â””â”€ Helius webhook logs (cloud)
```

---

## â±ï¸ Performance Benchmarks

### Operation Latency Table

| Operation | Frontend â†’ Backend | Backend â†’ Blockchain | Blockchain Confirm | Event Index | WebSocket Broadcast | **Total E2E** |
|-----------|-------------------|---------------------|-------------------|-------------|-------------------|--------------|
| Create Market | 50-200ms | 100-500ms | 400-800ms | 200-1000ms | 50-200ms | **2-5 seconds** |
| Buy Shares | 50-200ms | 100-500ms | 400-800ms | 200-1000ms | 50-200ms | **3-7 seconds** |
| Submit Vote | 50-200ms | N/A (off-chain) | N/A | 50-150ms | Instant | **100-500ms** |
| Aggregate Votes | N/A (cron) | 100-500ms | 400-800ms | 200-1000ms | 50-200ms | **5-10 minutes** |
| Transition State | N/A (cron) | 100-500ms | 400-800ms | 200-1000ms | 50-200ms | **5-10 minutes** |
| Claim Winnings | 50-200ms | 100-500ms | 400-800ms | 200-1000ms | 50-200ms | **3-7 seconds** |
| Load Market List | 50-200ms | N/A | N/A | N/A | N/A | **50-200ms** |
| Query Position | 50-200ms | N/A | N/A | N/A | N/A | **50-200ms** |

**Key Bottlenecks:**
1. Blockchain confirmation: 400-800ms (unavoidable)
2. Webhook delivery: 200-1000ms (Helius â†’ Event Indexer latency)
3. Cron interval: 5 minutes (for batch operations)

**Optimization Opportunities:**
1. Add Redis caching: Reduce database queries from 200ms â†’ 10ms
2. Batch webhook processing: Process multiple events simultaneously
3. Optimize database indexes: Faster queries on market_id, trader, timestamp
4. Connection pooling: Reduce Supabase connection overhead

---

## ğŸ”„ Error & Retry Flows

### Failed Transaction Recovery

```
User submits transaction
   â”‚
   â–¼
Blockchain execution fails
   â”‚
   â”œâ”€ Error: Slippage exceeded
   â”‚  â””â”€ Frontend shows: "Price moved. Adjust slippage or retry."
   â”‚     User increases slippage â†’ Retry
   â”‚
   â”œâ”€ Error: Insufficient SOL
   â”‚  â””â”€ Frontend shows: "Insufficient balance. Need 0.595 SOL, have 0.3 SOL."
   â”‚     User adds funds â†’ Retry
   â”‚
   â”œâ”€ Error: Market not active
   â”‚  â””â”€ Frontend shows: "Market is no longer active."
   â”‚     No retry possible
   â”‚
   â””â”€ Error: Already claimed
      â””â”€ Frontend shows: "You already claimed winnings."
         Refresh page â†’ Show claimed status
```

### Webhook Delivery Failure

```
Blockchain confirms transaction
   â”‚
   â–¼
Helius attempts webhook delivery
   â”‚
   â”œâ”€ Success (HTTP 200)
   â”‚  â””â”€ Event indexed normally
   â”‚
   â”œâ”€ Failure (HTTP 5xx or timeout)
   â”‚  â””â”€ Helius retries with exponential backoff
   â”‚     - Retry 1: 1 second
   â”‚     - Retry 2: 2 seconds
   â”‚     - Retry 3: 4 seconds
   â”‚     - Retry 4: 8 seconds
   â”‚     - Max retries: 5
   â”‚     â””â”€ If all fail: Event lost
   â”‚        Fallback: Manual re-indexing via RPC query
   â”‚
   â””â”€ Event Indexer down
      â””â”€ Webhooks queue on Helius side
         When Event Indexer recovers:
         - Helius delivers queued webhooks
         - Events indexed (delayed)
```

### Database Write Failure

```
Event Indexer receives webhook
   â”‚
   â–¼
Attempt Supabase write
   â”‚
   â”œâ”€ Success
   â”‚  â””â”€ Webhook acknowledged (HTTP 200)
   â”‚
   â”œâ”€ Duplicate key error
   â”‚  â””â”€ Event already indexed (idempotent)
   â”‚     Webhook acknowledged (HTTP 200)
   â”‚
   â”œâ”€ Network error (timeout)
   â”‚  â””â”€ Return HTTP 500 to Helius
   â”‚     Helius retries webhook
   â”‚
   â””â”€ Supabase down
      â””â”€ Return HTTP 503 to Helius
         Helius retries webhook
         Meanwhile: Log error, alert team
```

### WebSocket Disconnection

```
Frontend subscribed to market updates
   â”‚
   â–¼
WebSocket connection drops
   â”‚
   â”œâ”€ Auto-reconnect (client-side)
   â”‚  â””â”€ Reconnect successful
   â”‚     - Re-subscribe to channels
   â”‚     - Request missed events (since last seen)
   â”‚     - Resume normal operation
   â”‚
   â””â”€ Reconnect fails (server down)
      â””â”€ Fallback to polling (every 5 seconds)
         - GET /api/markets/:id
         - Update UI from API response
         - Show "Real-time updates unavailable" banner
         - Continue polling until WebSocket recovers
```

---

## ğŸ“Š Data Consistency Guarantees

### Strong Consistency (Blockchain)

**Guarantee:** All nodes see same state after confirmation

```
Transaction confirmed on blockchain
   â†’ State immediately consistent across all validators
   â†’ Any RPC query returns same result
   â†’ No eventual consistency issues
```

**Trade-off:** Higher latency (400-800ms confirmation)

---

### Eventual Consistency (Database)

**Guarantee:** Database will eventually match blockchain state

```
Blockchain state changes
   â†’ Webhook triggered (200-1000ms delay)
   â†’ Event Indexer writes to database
   â†’ Database consistent (1-5 seconds total)
```

**Inconsistency Window:** 1-5 seconds

**Handling Stale Data:**
- Frontend optimistic UI updates (instant feedback)
- WebSocket notifications (sub-second updates)
- Polling fallback (5-second intervals)
- "Pending" states for unconfirmed actions

---

### Cache Consistency (Redis - Planned)

**Guarantee:** Cache invalidated on writes, max staleness 5 minutes

```
Database write occurs
   â†’ Cache key invalidated immediately
   â†’ Next read fetches fresh data
   â†’ Cache repopulated (5 min TTL)
```

**Stale Read Possibility:** Up to 5 minutes if cache not invalidated

---

## ğŸ”— Related Documentation

- [INTEGRATION_MAP.md](./INTEGRATION_MAP.md) - Architecture & component connections
- [PROGRAMS_REFERENCE.md](../components/PROGRAMS_REFERENCE.md) - On-chain instruction details
- [BACKEND_REFERENCE.md](../components/BACKEND_REFERENCE.md) - Backend service details
- [API_REFERENCE.md](../api/API_REFERENCE.md) â³ - API endpoint specifications
- [TESTING_MASTER.md](../testing/TESTING_MASTER.md) - Testing infrastructure

---

**Last Updated:** 2025-11-09 00:45 PST
**Next Review:** 2025-11-16
**Maintained By:** Development Team
**Auto-Update:** When data flows change

---
