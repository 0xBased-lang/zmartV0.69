/**
 * Initialize Global Config using raw Solana transactions
 * Bypasses Anchor SDK to avoid IDL compatibility issues
 */

import {
  Connection,
  PublicKey,
  Keypair,
  Transaction,
  TransactionInstruction,
  SystemProgram,
  sendAndConfirmTransaction,
  LAMPORTS_PER_SOL,
} from '@solana/web3.js';
import * as borsh from 'borsh';
import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Constants
const PROGRAM_ID = new PublicKey('7h3gXfBfYFueFVLYyfL5Qo1QGsf4GQUfW96FKVgnUsJS');
const RPC_URL = 'https://api.devnet.solana.com';

// Instruction discriminator for initialize_global_config
// Generated by Anchor from the IDL
const INITIALIZE_DISCRIMINATOR = Buffer.from([113, 216, 122, 131, 225, 209, 22, 55]);

async function main() {
  console.log('='.repeat(60));
  console.log('Initialize Global Config (Raw Transaction)');
  console.log('='.repeat(60));

  // Setup connection
  const connection = new Connection(RPC_URL, 'confirmed');

  // Load wallet
  const walletPath = path.join(process.env.HOME, '.config/solana/id.json');
  const walletKeypair = Keypair.fromSecretKey(
    new Uint8Array(JSON.parse(fs.readFileSync(walletPath, 'utf-8')))
  );

  console.log(`\nAdmin: ${walletKeypair.publicKey.toString()}`);

  // Check balance
  const balance = await connection.getBalance(walletKeypair.publicKey);
  console.log(`Balance: ${(balance / LAMPORTS_PER_SOL).toFixed(4)} SOL`);

  if (balance < 0.1 * LAMPORTS_PER_SOL) {
    console.log(`\nâŒ Insufficient balance! Need at least 0.1 SOL`);
    return;
  }

  // Derive global config PDA
  const [globalConfigPDA, bump] = PublicKey.findProgramAddressSync(
    [Buffer.from('global-config')],
    PROGRAM_ID
  );

  console.log(`\nGlobal Config PDA: ${globalConfigPDA.toString()}`);
  console.log(`Bump: ${bump}`);

  // Check if already initialized
  try {
    const existingConfig = await connection.getAccountInfo(globalConfigPDA);
    if (existingConfig) {
      console.log(`\nâŒ Global Config already initialized!`);
      console.log(`   Size: ${existingConfig.data.length} bytes`);
      console.log(`   Owner: ${existingConfig.owner.toString()}`);
      console.log(`\nSkipping initialization.`);
      return;
    }
  } catch (e) {
    // Account doesn't exist, continue
  }

  console.log(`\nâœ… Ready to initialize`);

  // Backend authority (same as admin for now)
  const backendAuthority = walletKeypair.publicKey;
  const protocolFeeWallet = walletKeypair.publicKey;

  console.log(`\nParameters:`);
  console.log(`   Backend Authority: ${backendAuthority.toString()}`);
  console.log(`   Protocol Fee Wallet: ${protocolFeeWallet.toString()}`);

  // Build instruction data
  // Format: [discriminator (8 bytes)] + [backend_authority (32 bytes)]
  const instructionData = Buffer.concat([
    INITIALIZE_DISCRIMINATOR,
    backendAuthority.toBuffer(),
  ]);

  console.log(`\nInstruction data: ${instructionData.length} bytes`);

  // Build accounts for instruction
  const keys = [
    { pubkey: walletKeypair.publicKey, isSigner: true, isWritable: true }, // admin
    { pubkey: globalConfigPDA, isSigner: false, isWritable: true }, // global_config
    { pubkey: protocolFeeWallet, isSigner: false, isWritable: false }, // protocol_fee_wallet
    { pubkey: SystemProgram.programId, isSigner: false, isWritable: false }, // system_program
  ];

  // Create instruction
  const instruction = new TransactionInstruction({
    keys,
    programId: PROGRAM_ID,
    data: instructionData,
  });

  // Create transaction
  const transaction = new Transaction().add(instruction);

  console.log(`\n${'='.repeat(60)}`);
  console.log(`Sending transaction...`);
  console.log(`${'='.repeat(60)}`);

  try {
    const signature = await sendAndConfirmTransaction(
      connection,
      transaction,
      [walletKeypair],
      {
        commitment: 'confirmed',
        preflightCommitment: 'confirmed',
      }
    );

    console.log(`\nâœ… Transaction confirmed!`);
    console.log(`   Signature: ${signature}`);
    console.log(`   Explorer: https://explorer.solana.com/tx/${signature}?cluster=devnet`);

    // Wait for account data
    console.log(`\nâ³ Waiting for account data...`);
    await new Promise(resolve => setTimeout(resolve, 3000));

    // Verify
    const accountInfo = await connection.getAccountInfo(globalConfigPDA);

    if (accountInfo) {
      console.log(`\nâœ… Account created successfully!`);
      console.log(`   Owner: ${accountInfo.owner.toString()}`);
      console.log(`   Size: ${accountInfo.data.length} bytes`);
      console.log(`   Lamports: ${(accountInfo.lamports / LAMPORTS_PER_SOL).toFixed(6)} SOL`);

      console.log(`\n${'='.repeat(60)}`);
      console.log(`ðŸŽ‰ Global Config Initialization Complete!`);
      console.log(`${'='.repeat(60)}`);
      console.log(`\nâœ… Status: SUCCESS`);
      console.log(`ðŸ“‹ PDA: ${globalConfigPDA.toString()}`);
      console.log(`\nðŸ’¡ Next Steps:`);
      console.log(`   1. Verify config with: node scripts/check-simple.mjs`);
      console.log(`   2. Create a test market`);
      console.log(`   3. Test frontend integration`);
      console.log(`${'='.repeat(60)}\n`);
    } else {
      console.log(`\nâŒ Account not found after transaction!`);
    }

  } catch (error) {
    console.error(`\nâŒ Transaction failed:`, error);

    if (error.logs) {
      console.log(`\nðŸ“‹ Program Logs:`);
      error.logs.forEach((log, i) => console.log(`   ${i + 1}. ${log}`));
    }

    process.exit(1);
  }
}

main().catch(console.error);
