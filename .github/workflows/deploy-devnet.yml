name: Deploy to Devnet

on:
  push:
    branches: [main]
    tags:
      - 'v*-devnet'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment trigger'

jobs:
  deploy-programs:
    name: Deploy Solana Programs
    runs-on: ubuntu-latest
    environment: devnet
    steps:
      - uses: actions/checkout@v4

      - name: Install Solana
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v1.18.0/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          avm install latest
          avm use latest

      - name: Configure Solana for Devnet
        run: |
          solana config set --url https://api.devnet.solana.com
          echo "${{ secrets.SOLANA_DEVNET_DEPLOYER_KEY }}" > deployer-keypair.json
          solana config set --keypair deployer-keypair.json

      - name: Check wallet balance
        run: |
          BALANCE=$(solana balance | awk '{print $1}')
          echo "Wallet balance: $BALANCE SOL"
          if (( $(echo "$BALANCE < 1.0" | bc -l) )); then
            echo "⚠️  Warning: Low balance, requesting airdrop..."
            solana airdrop 2 || echo "Airdrop failed, continuing with current balance"
          fi

      - name: Build programs
        run: anchor build

      - name: Deploy programs
        run: |
          echo "Deploying to devnet..."
          anchor deploy --provider.cluster devnet

      - name: Verify deployment
        run: |
          echo "Program IDs deployed:"
          anchor keys list

      - name: Save program IDs
        run: |
          mkdir -p deployment-artifacts
          anchor keys list > deployment-artifacts/program-ids-devnet.txt
          echo "Deployed at: $(date)" >> deployment-artifacts/program-ids-devnet.txt
          echo "Git commit: ${{ github.sha }}" >> deployment-artifacts/program-ids-devnet.txt

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: devnet-deployment-${{ github.sha }}
          path: deployment-artifacts/
          retention-days: 90

  deploy-backend:
    name: Deploy Backend Services
    runs-on: ubuntu-latest
    needs: deploy-programs
    environment: devnet
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        working-directory: ./backend
        run: pnpm install --frozen-lockfile

      - name: Build backend
        working-directory: ./backend
        run: pnpm run build

      - name: Deploy to server (placeholder)
        run: |
          echo "Backend deployment would happen here"
          echo "Options: Railway, Render, DigitalOcean, AWS, etc."
          echo "Configure deployment in future iteration"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-programs
    environment: devnet
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_SOLANA_NETWORK: devnet
          NEXT_PUBLIC_API_URL: ${{ secrets.DEVNET_API_URL }}
        run: pnpm run build

      - name: Deploy to Vercel (placeholder)
        run: |
          echo "Frontend deployment would happen here"
          echo "Options: Vercel, Netlify, Cloudflare Pages, etc."
          echo "Configure deployment in future iteration"

  post-deployment:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy-programs, deploy-backend, deploy-frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Create deployment notification
        run: |
          echo "✅ Devnet Deployment Complete"
          echo "================================"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Time: $(date)"
          echo ""
          echo "Next steps:"
          echo "1. Verify programs on Solana Explorer"
          echo "2. Test backend API endpoints"
          echo "3. Test frontend user flows"
          echo "4. Monitor logs for errors"

      - name: Discord notification (placeholder)
        run: |
          echo "Send Discord webhook notification here"
          # curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
          #   -H "Content-Type: application/json" \
          #   -d '{"content": "✅ Devnet deployment complete!"}'
